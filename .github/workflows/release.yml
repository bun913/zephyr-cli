name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js for npm publish
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Update package version
        run: |
          bun --version
          # Update package.json version manually since bun doesn't have version command yet
          sed -i 's/"version": "[^"]*"/"version": "${{ steps.version.outputs.VERSION }}"/' package.json

      - name: Install dependencies
        run: bun install

      - name: Lint
        run: bun run lint

      - name: Build
        run: bun run build

      - name: Publish to npm
        run: npm publish --provenance --access public

      - name: Create release branch
        run: |
          git checkout -b release/v${{ steps.version.outputs.VERSION }}
          git add package.json bun.lock
          git commit -m "chore: bump version to v${{ steps.version.outputs.VERSION }}"
          git push origin release/v${{ steps.version.outputs.VERSION }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const version = '${{ steps.version.outputs.VERSION }}';

            const pr = await github.rest.pulls.create({
              title: `chore: release v${version}`,
              owner,
              repo,
              head: `release/v${version}`,
              base: 'main',
              body: [
                `# Release v${version}`,
                '',
                '## Changes',
                '- Version bump to v' + version,
                '- Package published to npm',
                '',
                '## Installation',
                '```bash',
                `npm install -g zephyr-cli@${version}`,
                '# or',
                `bun add -g zephyr-cli@${version}`,
                '```',
                '',
                `**Full Changelog**: https://github.com/${owner}/${repo}/compare/v${version}...HEAD`
              ].join('\n')
            });

  build-binaries:
    needs: release
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: darwin-arm64
            artifact: zephyr-macos-arm64
          - os: macos-latest
            target: darwin-x64
            artifact: zephyr-macos-x64
          - os: ubuntu-latest
            target: linux-x64
            artifact: zephyr-linux-x64
          - os: windows-latest
            target: windows-x64
            artifact: zephyr-windows-x64.exe

    steps:
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build binary
        run: bun build src/index.ts --compile --target=bun-${{ matrix.target }} --outfile ${{ matrix.artifact }}

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.artifact }}
          tag_name: v${{ steps.version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
